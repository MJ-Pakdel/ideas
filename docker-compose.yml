services:
  # Zipkin for tracing
  zipkin:
    image: openzipkin/zipkin
    container_name: idaes-zipkin
    ports:
      - "9411:9411"
    depends_on:
      - otel-collector
    networks:
      - idaes-network
    restart: unless-stopped

  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.111.0
    container_name: idaes-otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ${PWD}/configs/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    networks:
      - idaes-network
    restart: unless-stopped

  # ChromaDB service with telemetry
  chromadb:
    image: chromadb/chroma:latest
    container_name: idaes-chromadb
    ports:
      - "8000:8000"
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
      - CHROMA_SERVER_GRPC_PORT=50051
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
      - CHROMA_OPEN_TELEMETRY__ENDPOINT=http://otel-collector:4317
      - CHROMA_OPEN_TELEMETRY__SERVICE_NAME=chroma
    volumes:
      - chromadb_data:/chroma/chroma
    networks:
      - idaes-network
    depends_on:
      - otel-collector
      - zipkin
    restart: unless-stopped

  # IDAES service
  idaes:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: idaes
    ports:
      - "8081:8081" # main application
      - "6060:6060" # pprof port
      - "8082:8082" # metrics port
    command:
      [
        "./idaes",
        "-chroma-url",
        "http://chromadb:8000",
        "-ollama-url",
        "http://spark:11434",
        "-host",
        "0.0.0.0",
        "-port",
        "8081",
        "-enable_web=true",
        "-enable-display=false",
        "-enable-gpio=false",
        "-enable_idaes=true",
        "-enable_pprof=true",
        "-worker_count",
        "4",
        "-max-concurrent-docs",
        "4",
        "-parallel-processing=true",
        "-llm-timeout",
        "120s",
        "-llm-retry-attempts",
        "3",
        "-debug=true",
      ]
    volumes:
      - fs_vectorize_data:/app/data
    networks:
      - idaes-network
    depends_on:
      - chromadb
      - otel-collector
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8081/api/v1/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: idaes-nginx
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx_logs:/var/log/nginx
    networks:
      - idaes-network
    depends_on:
      - idaes
      - chromadb
      - zipkin
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  chromadb_data:
    driver: local
  fs_vectorize_data:
    driver: local
  nginx_logs:
    driver: local

networks:
  idaes-network:
    driver: bridge
